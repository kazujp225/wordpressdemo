# モバイルスクリーンショット取得の問題報告書

## 概要
URLからのモバイル版スクリーンショット取得が、本番環境（Render）で安定して動作しない問題が発生しています。

---

## 現状の問題

### 1. タイムアウトの連鎖
モバイル版の取得時、以下の順序でタイムアウトが発生：

| ステップ | 状態 | 詳細 |
|---------|------|------|
| Navigation | タイムアウト | 25秒で切れる。部分的コンテンツで続行 |
| Scroll処理 | タイムアウト | `Runtime.callFunctionOn timed out` |
| 画像読み込み | 成功 | - |
| ポップアップ除去 | 成功 | - |
| スクリーンショット撮影 | **失敗** | 撮影開始前にサーバーが再起動 |

### 2. サーバー再起動
- モバイル取得中（233秒経過時点）でRenderがサーバーを再起動
- 原因推定：メモリ不足 or プロセスタイムアウト
- 結果：502エラーがクライアントに返される

### 3. デスクトップとの差異

| 項目 | デスクトップ | モバイル |
|------|-------------|---------|
| ビューポート | 1280x800 | 375x812 |
| ページ高さ（例） | 12,031px | 18,231px |
| 必要キャプチャ数 | 16枚 | 23枚 |
| 実際の取得枚数 | 8枚（成功） | 5枚（失敗） |
| 処理時間 | 約148秒 | 233秒以上（失敗） |

---

## 技術的制約

### Render（本番環境）の制限
1. **HTTPタイムアウト**: 30秒（ただしストリーミングは継続可能）
2. **メモリ**: 512MB〜2GB（プランによる）
3. **プロセス**: 長時間実行でサーバー再起動の可能性

### Puppeteer/Chromiumの問題
1. **protocolTimeout**: 30秒に設定済みだがモバイルでは不足
2. **メモリ消費**: モバイルページは縦に長く、メモリ消費が大きい
3. **page.evaluate()**: モバイルサイトではJSの実行に時間がかかる

---

## 試した対策と結果

| 対策 | 結果 |
|------|------|
| スクロール処理を4箇所ジャンプに簡略化 | タイムアウトは減ったが根本解決せず |
| 撮影枚数を10枚→5枚に削減 | 効果なし（撮影前に失敗） |
| 待ち時間を100ms→30msに短縮 | 効果なし |
| 画像読み込み処理を軽量化 | 効果なし |
| try-catchでエラーをスキップ | 部分的に効果あり |

---

## 改善案（検討依頼）

### 案1: モバイル取得を本番環境で諦める
- **方法**: 追加取得ボタンからモバイルを削除
- **メリット**: すぐに実装可能、安定性向上
- **デメリット**: 機能制限、ユーザー体験低下

### 案2: 最初のインポート時のみモバイル対応
- **方法**: PagesHeaderの2段階インポート（デスクトップ→モバイル）は維持
- **メリット**: 1回だけなら成功率が高い（連続実行が問題）
- **デメリット**: 追加取得でモバイルが使えない

### 案3: サーバー環境のアップグレード
- **方法**: Renderのプランをアップグレード（メモリ増量）
- **メリット**: 根本的解決の可能性
- **デメリット**: コスト増、効果は不確定

### 案4: 別サービスへの移行
- **方法**: Railway、Fly.io、AWS Lambdaなどに移行
- **メリット**: タイムアウト制限が緩い可能性
- **デメリット**: 移行コスト、検証が必要

### 案5: 非同期処理への変更（大規模改修）
- **方法**:
  1. スクリーンショット取得をバックグラウンドジョブ化
  2. ユーザーには「処理中」を表示
  3. 完了したら通知（WebSocket or ポーリング）
- **メリット**: HTTPタイムアウトの影響を受けない
- **デメリット**: 実装コスト大、アーキテクチャ変更が必要

### 案6: 外部スクリーンショットサービスの利用
- **方法**: Browserless.io、ScrapingBee等のAPIを利用
- **メリット**: インフラ管理不要、安定性高い
- **デメリット**: 月額コスト発生、依存性

---

## 推奨

**短期（即時対応）**: 案2を採用
- 追加取得からモバイルボタンを削除
- 最初のインポート時の2段階（デスクトップ→モバイル）は維持

**中期（検討）**: 案3または案5
- Renderプランアップグレードで解決するか検証
- または非同期処理への移行を検討

---

## 質問事項

1. モバイル取得機能の優先度はどの程度か？
2. 追加コスト（サーバーアップグレード or 外部サービス）は許容できるか？
3. 非同期処理への変更は受け入れられるか？

---

## 参考ログ

```
[IMPORT-URL INFO] Document height: 18231px, Viewport: 375x812
[IMPORT-URL INFO] Total captures: 23, Starting from: 0, Capturing: 5
...（撮影ログなし）...
[POST] responseTimeMS=233168 （約4分）
==> Running 'npm run start' （サーバー再起動）
```

以上
