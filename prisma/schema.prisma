datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
}

model Page {
  id               Int           @id @default(autoincrement())
  userId           String?       // Supabase Auth user ID
  title            String
  slug             String        @unique
  status           String        @default("draft")
  templateId       String        @default("simple")
  headerConfig     String
  formConfig       String
  isFavorite       Boolean       @default(false)
  designDefinition String?       // JSON string of extracted design style (colors, vibe, typography)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  sections         PageSection[]

  @@index([userId])
}

model PageSection {
  id                   Int         @id @default(autoincrement())
  pageId               Int
  page                 Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)
  order                Int
  role                 String
  imageId              Int?
  image                MediaImage? @relation("DesktopImage", fields: [imageId], references: [id])
  mobileImageId        Int?
  mobileImage          MediaImage? @relation("MobileImage", fields: [mobileImageId], references: [id])
  config               String?
  boundaryOffsetTop    Int         @default(0) // AI認識範囲の上方向拡張（ピクセル）
  boundaryOffsetBottom Int         @default(0) // AI認識範囲の下方向拡張（ピクセル）
}

model MediaImage {
  id              Int           @id @default(autoincrement())
  userId          String?       // Supabase Auth user ID
  filePath        String
  width           Int?
  height          Int?
  mime            String
  prompt          String?       // 生成に使用されたプロンプト
  hash            String?       @unique // プロンプトのハッシュ（キャッシュ用）
  sourceUrl       String?       // URLインポートの元URL
  sourceType      String?       // "import" | "ai-generate" | "upload" など
  createdAt       DateTime      @default(now())
  desktopSections PageSection[] @relation("DesktopImage")
  mobileSections  PageSection[] @relation("MobileImage")

  @@index([userId])
  @@index([sourceUrl])
}

model GenerationRun {
  id            Int      @id @default(autoincrement())
  createdAt     DateTime @default(now())
  userId        String?  // Supabase Auth user ID
  type          String   // 'copy' | 'image' | 'inpaint' | 'edit-image' | 'prompt-copilot' | 'review' | 'image-to-prompt' | 'generate-nav' | 'chat-edit' | 'lp-generate'
  endpoint      String?  // API endpoint path (e.g., '/api/ai/generate-image')
  model         String
  inputPrompt   String
  outputResult  String?
  inputTokens   Int?     // Input token count
  outputTokens  Int?     // Output token count
  imageCount    Int?     // Number of images generated
  estimatedCost Float?   // Estimated cost in USD
  status        String   @default("succeeded")
  errorMessage  String?
  durationMs    Int?     // Request duration in milliseconds

  @@index([userId])
  @@index([createdAt])
  @@index([type])
}

model GlobalConfig {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String // JSON string
}

model UserSettings {
  id            Int      @id @default(autoincrement())
  userId        String   @unique // Supabase Auth user ID
  email         String?  // ユーザーのメールアドレス
  plan          String   @default("normal") // normal or premium
  googleApiKey  String?  // ユーザー固有のGoogle API Key
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model InpaintHistory {
  id            Int      @id @default(autoincrement())
  userId        String?  // Supabase Auth user ID
  originalImage String   // 変更前の画像URL
  resultImage   String   // 変更後の画像URL
  prompt        String   // 編集指示
  masks         String   // JSON: 選択範囲の座標 [{x, y, width, height}, ...]
  model         String   // 使用モデル名
  estimatedCost Float?   // 推定費用 (USD)
  durationMs    Int?     // 処理時間 (ms)
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model SectionImageHistory {
  id            Int      @id @default(autoincrement())
  sectionId     Int      // PageSection ID
  userId        String?  // Supabase Auth user ID
  previousImageId Int    // 変更前のMediaImage ID
  newImageId    Int      // 変更後のMediaImage ID
  actionType    String   // 'regenerate' | 'inpaint' | 'upload' など
  prompt        String?  // 使用されたプロンプト（あれば）
  createdAt     DateTime @default(now())

  @@index([sectionId])
  @@index([userId])
  @@index([createdAt])
}

model MediaVideo {
  id            Int      @id @default(autoincrement())
  userId        String?  // Supabase Auth user ID
  filePath      String   // 動画ファイルのURL
  thumbnailPath String?  // サムネイル画像のURL
  duration      Int?     // 動画の長さ（秒）
  width         Int?
  height        Int?
  mime          String   // video/mp4, video/webm など
  fileSize      Int?     // ファイルサイズ（バイト）
  prompt        String?  // AI生成の場合のプロンプト
  sourceType    String   @default("upload") // "upload" | "youtube" | "vimeo" | "ai-generate"
  sourceUrl     String?  // YouTube/VimeoのURL
  createdAt     DateTime @default(now())

  @@index([userId])
}
