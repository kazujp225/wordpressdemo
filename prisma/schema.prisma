generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
}

model Page {
  id               Int           @id @default(autoincrement())
  userId           String?
  title            String
  slug             String        @unique
  status           String        @default("draft")
  templateId       String        @default("simple")
  headerConfig     String
  formConfig       String
  isFavorite       Boolean       @default(false)
  designDefinition String?
  seoData          String?       @db.Text // SEO/LLMOステルス対策データ（JSON）
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  sections         PageSection[]

  @@index([userId])
}

model PageSection {
  id                   Int         @id @default(autoincrement())
  pageId               Int
  order                Int
  role                 String
  imageId              Int?
  config               String?
  mobileImageId        Int?
  boundaryOffsetBottom Int         @default(0)
  boundaryOffsetTop    Int         @default(0)
  image                MediaImage? @relation("DesktopImage", fields: [imageId], references: [id])
  mobileImage          MediaImage? @relation("MobileImage", fields: [mobileImageId], references: [id])
  page                 Page        @relation(fields: [pageId], references: [id], onDelete: Cascade)
}

model MediaImage {
  id              Int           @id @default(autoincrement())
  userId          String?
  filePath        String
  width           Int?
  height          Int?
  mime            String
  prompt          String?
  hash            String?       @unique
  sourceUrl       String?
  sourceType      String?
  createdAt       DateTime      @default(now())
  desktopSections PageSection[] @relation("DesktopImage")
  mobileSections  PageSection[] @relation("MobileImage")

  @@index([userId])
  @@index([sourceUrl])
}

model GenerationRun {
  id            Int      @id @default(autoincrement())
  createdAt     DateTime @default(now())
  userId        String?
  type          String
  endpoint      String?
  model         String
  inputPrompt   String
  outputResult  String?
  inputTokens   Int?
  outputTokens  Int?
  imageCount    Int?
  estimatedCost Float?
  status        String   @default("succeeded")
  errorMessage  String?
  durationMs    Int?

  @@index([userId])
  @@index([createdAt])
  @@index([type])
  @@index([userId, createdAt])
  @@index([userId, status])
}

model GlobalConfig {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String
}

model UserSettings {
  id                Int       @id @default(autoincrement())
  userId            String    @unique
  email             String?
  role              String    @default("user") // 'user' | 'admin'
  plan              String    @default("free")
  googleApiKey      String?
  renderApiKey      String?
  githubToken       String?
  githubDeployOwner String?
  isBanned          Boolean   @default(false)
  bannedAt          DateTime?
  bannedBy          String?
  banReason         String?
  resendApiKey      String?
  notificationEmail String?
  resendFromDomain  String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model InpaintHistory {
  id            Int      @id @default(autoincrement())
  userId        String?
  originalImage String
  resultImage   String
  prompt        String
  masks         String
  model         String
  estimatedCost Float?
  durationMs    Int?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model SectionImageHistory {
  id              Int      @id @default(autoincrement())
  sectionId       Int
  userId          String?
  previousImageId Int
  newImageId      Int
  actionType      String
  prompt          String?
  createdAt       DateTime @default(now())

  @@index([sectionId])
  @@index([userId])
  @@index([createdAt])
}

model MediaVideo {
  id            Int      @id @default(autoincrement())
  userId        String?
  filePath      String
  thumbnailPath String?
  duration      Int?
  width         Int?
  height        Int?
  mime          String
  fileSize      Int?
  prompt        String?
  sourceType    String   @default("upload")
  sourceUrl     String?
  createdAt     DateTime @default(now())

  @@index([userId])
}

model FormSubmission {
  id          Int       @id @default(autoincrement())
  pageId      Int
  pageSlug    String
  formTitle   String?
  fields      String
  senderEmail String?
  senderName  String?
  isRead      Boolean   @default(false)
  notifiedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@index([createdAt])
  @@index([isRead])
  @@index([pageId])
  @@index([pageSlug])
}

model WaitingRoomEntry {
  id          Int                  @id @default(autoincrement())
  accountType String               // 'individual' or 'corporate'
  companyName String?
  name        String
  email       String
  phone       String?
  remarks     String?
  status      String               @default("pending") // pending, approved, rejected, invited, registered
  plan        String?              // 選択されたプラン: free, poc, pro, expert
  adminNotes  String?              // 管理者用メモ
  processedAt DateTime?            // 処理日時
  processedBy String?              // 処理した管理者のID
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  replies     WaitingRoomReply[]

  @@index([email])
  @@index([status])
  @@index([createdAt])
}

model WaitingRoomReply {
  id        Int              @id @default(autoincrement())
  entryId   Int
  message   String           // 返信メッセージ
  adminId   String           // 返信した管理者のID
  adminName String?          // 管理者名（表示用）
  isRead    Boolean          @default(false) // 申請者が読んだかどうか
  createdAt DateTime         @default(now())
  entry     WaitingRoomEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([entryId])
  @@index([createdAt])
}

// ========================================
// デプロイ管理
// ========================================

model Deployment {
  id              Int      @id @default(autoincrement())
  userId          String
  pageId          Int?
  serviceName     String
  renderServiceId String?
  siteUrl         String?
  status          String   @default("pending") // pending | building | live | failed
  generatedHtml   String?  @db.Text
  templateType    String?
  prompt          String?  @db.Text
  githubRepoUrl   String?
  errorMessage    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// ========================================
// クレジット・課金関連テーブル
// ========================================

// クレジット残高管理
model CreditBalance {
  id              Int       @id @default(autoincrement())
  userId          String    @unique
  balanceUsd      Decimal   @default(0) @db.Decimal(18, 6) // USD残高
  lastRefreshedAt DateTime? // 最後のプラン付与日
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

// クレジット取引履歴
model CreditTransaction {
  id              Int      @id @default(autoincrement())
  userId          String
  type            String   // 'plan_grant' | 'api_usage' | 'purchase' | 'refund' | 'adjustment'
  amountUsd       Decimal  @db.Decimal(18, 6) // 正=加算、負=消費
  balanceAfter    Decimal  @db.Decimal(18, 6) // 取引後残高
  description     String?
  generationRunId Int? // GenerationRunへの参照（API使用時）
  model           String? // 使用モデル
  inputTokens     Int?
  outputTokens    Int?
  imageCount      Int?
  stripePaymentId String?  @unique // Stripe決済ID（購入時）
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([type])
  @@index([userId, type, createdAt])
}

// クレジットパッケージ（購入可能な単位）
model CreditPackage {
  id        Int      @id @default(autoincrement())
  name      String // "500円分", "1000円分" etc
  priceJpy  Int // 日本円価格
  creditUsd Decimal  @db.Decimal(18, 6) // 付与されるUSDクレジット
  isActive  Boolean  @default(true)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
}

// Stripeサブスクリプション管理
model Subscription {
  id                   Int       @id @default(autoincrement())
  userId               String    @unique
  stripeCustomerId     String    @unique
  stripeSubscriptionId String?   @unique
  stripePriceId        String?
  plan                 String    @default("pro") // pro | business | enterprise
  status               String    @default("active") // active | canceled | past_due | unpaid
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([stripeCustomerId])
}

// Stripe Webhookイベント処理履歴（冪等性確保）
model WebhookEvent {
  id          Int       @id @default(autoincrement())
  eventId     String    @unique // Stripe event.id (e.g., evt_1234567890abcdef)
  eventType   String    // checkout.session.completed, invoice.paid, etc.
  status      String    @default("pending") // pending | processing | completed | failed
  rawData     String?   @db.Text // Full event JSON (optional for debugging)
  error       String?   @db.Text // Error message if failed
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([eventId])
  @@index([eventType, createdAt])
  @@index([status])
}
